#INCLUDE<P16F628.INC>
		__CONFIG 3F10
		
;DECLARACION DE ESPACIOS DE MEMORIA A USAR		
		CBLOCK	0X20
		D1
		D2
		D3
		D4
		AUX_W
		AUX_STATUS
		CONT1	
		CONT2
		CONT_N
		N
		N1
		N2
		RESULTADO
		CONT_M
		CONT
		ENDC		

;DECLARACION DE CONSTANTES
#DEFINE BTN_G1 	PORTA,6
#DEFINE BTN_G2 	PORTA,7
#DEFINE BTN_R 	PORTA,4
#DEFINE BTN_M 	PORTB,0

#DEFINE PIN_D1 	3
#DEFINE PIN_D2 	2
#DEFINE PIN_D3 	0
#DEFINE PIN_D4 	1

#DEFINE	CTRL_DISPLAY	PORTA
#DEFINE	APAGAR_DISPLAYS CLRF	PORTA

;DECLARACION DE MACROS

MOSTRAR	MACRO	DIGITO,PIN
		APAGAR_DISPLAYS
		MOVF	DIGITO,W
		CALL	TAB_DISPLAY
		MOVWF	PORTB
		BSF		CTRL_DISPLAY,PIN
		ENDM
	
;INICIO DEL PROGRAMA		
		
		ORG		0X00
		GOTO	INICIO
		ORG		0X04		

;RUTINA DE INTERRUPCION
;DESBORDA EL TIMER CADA 15ms
;MUESTRA TODOS LOS DIGITOS DE ACUERDO A LAS VARIABLES D1:4

;GUARDA STATUS Y W EN VARIABLES AUXILIARES
		BCF		INTCON,T0IF
		BCF		INTCON,GIE		
		MOVWF	AUX_W
		MOVLW	STATUS
		MOVWF	AUX_STATUS
;MULTIPLEXADO DE DISPLAYS
		BTFSC	CTRL_DISPLAY,PIN_D4
		GOTO	MOSTRAR_D1			
		BTFSC	CTRL_DISPLAY,PIN_D1
		GOTO	MOSTRAR_D2			
		BTFSC	CTRL_DISPLAY,PIN_D2
		GOTO	MOSTRAR_D3

MOSTRAR_D1		
		MOSTRAR	D1,PIN_D1
		GOTO 	FIN_T0I

MOSTRAR_D2
		MOSTRAR D2,PIN_D2
		GOTO 	FIN_T0I

MOSTRAR_D3
		MOSTRAR D3,PIN_D3
		GOTO 	FIN_T0I

		
FIN_T0I
;REINICIA TIMER Y RECUPERA STATUS Y W
		MOVLW	.198
		MOVWF	TMR0
		MOVF	AUX_STATUS,W
		MOVWF	STATUS
		MOVF	AUX_W,W
		RETFIE
		

;CONFIGURACION
		
INICIO
		
		MOVLW	0X07
		MOVWF	CMCON; CMCON ESTABLECE EN 7 PARA USAR TODO EL PORTA
		MOVLW	.198
		MOVWF	TMR0
		BSF		STATUS,RP0
		MOVLW	b'00000001'
		MOVWF	TRISB	
		MOVLW	b'11110000'
		MOVWF	TRISA
		BCF		OPTION_REG,T0CS
		BCF		OPTION_REG,PSA
		BSF		OPTION_REG,PS0
		BSF		OPTION_REG,PS1
		BSF		OPTION_REG,PS2
		BSF		INTCON,GIE
		BSF		INTCON,T0IE
		BCF		STATUS,RP0

;RUTINA PRINCIPAL
;INCREMENTA DE 0 A F CADA DIGITO DEPENDIENDO QUE BOTON SE TOCA. 

		CLRF	PORTA
		CLRF	PORTB
		CLRF	D1
		CLRF	D2
		CLRF	D3
		CLRF	D4
		CLRF 	CONT
		MOVLW	.2
		MOVF	CONT_M
		
BOTONES
		BTFSC	BTN_R
		CALL	DEMORA
		BTFSC	BTN_R
		CALL	REINICIO
		BTFSC	BTN_G1
		CALL	DEMORA
		CALL 	DEMORA
		BTFSC	BTN_G1
		CALL	INC_D3
		BTFSC	BTN_G2
		CALL	DEMORA
		BTFSC	BTN_G2
		CALL	DEC_D3
		BTFSC	BTN_M
		CALL	DEMORA
		BTFSC	BTN_M
		CALL	BOTON_M
	
		GOTO 	BOTONES

INC_D3
		INCF	CONT,1
		INCF	D3,1
		MOVF	D3,W
		XORLW	.16
		BTFSC	STATUS,Z
		CALL 	INC_D2
		RETURN

INC_D2
		CLRF	D3
		INCF	D2,1
		MOVF	D2,W
		XORLW	.16
		BTFSC	STATUS,Z
		CALL 	INC_D1
		RETURN

INC_D1
		CLRF	D2
		INCF	D1,1
		MOVF	D1,W
		XORLW	.16
		BTFSC	STATUS,Z
		CLRF	D1
		RETURN

DEC_D3
		DECF	CONT,1
		MOVLW	.1
		SUBWF	D3,W
		BTFSS	STATUS,C
		CALL 	VUELTA_D3
		DECF	D3
		RETURN

DEC_D2
		SUBWF	D2,W
		BTFSS	STATUS,C
		CALL	VUELTA_D2
		DECF	D2
		RETURN

DEC_D1
		SUBWF	D1,W
		BTFSS	STATUS,C
		CALL 	VUELTA_D1
		DECF	D1
		RETURN

VUELTA_D3

		MOVLW	.15
		MOVWF	D3
		CALL	DEC_D2
		RETURN

VUELTA_D2

		MOVLW	.15
		MOVWF	D2
		CALL	DEC_D1
		RETURN

VUELTA_D1

		MOVLW	.15
		MOVWF	D1
		GOTO BOTONES
		RETURN

BOTON_M
		CLRF	D3
		CLRF	D2
		CLRF	D1
		DECF	CONT_M,W
		XORLW	.0
		BTFSC	STATUS,Z
		GOTO	CAMBIO
		GOTO 	RESTA
		RETURN

CAMBIO
		MOVF	CONT,0
		MOVWF	N
		GOTO BOTONES
		RETURN

RESTA
	
		CLRW
		MOVF	CONT, W
		SUBWF	N, 0
		MOVWF	RESULTADO
		GOTO 	MOSTRAR_RESUL
		RETURN

MOSTRAR_RESUL
		
		DECFSZ	RESULTADO,F
		GOTO	MOSTRAR_2
		GOTO 	BOTONES
		RETURN

MOSTRAR_2
		
		CALL 	INC_D3
		GOTO	MOSTRAR_RESUL
		RETURN

REINICIO
		
		CLRF	D4
		CLRF	D3
		CLRF	D2
		CLRF	D1
		CLRF	RESULTADO
		CLRF	N
		CLRW
		GOTO 	INICIO

;DEMORA/////////////////////
DEMORA
		MOVLW	.255
		MOVWF	CONT1
C2
		MOVLW	.255
		MOVWF	CONT2
C1
		DECFSZ	CONT2,1
		GOTO	C1
		DECFSZ	CONT1,1
		GOTO	C2
		RETURN
			
;CONVERSOR A DISPLAY
;RB1->SEG A
;RB2->SEG B 
;RB3->SEG C
;RB4->SEG D
;RB5->SEG E 
;RB6->SEG F
;RB7->SEG G

TAB_DISPLAY
		ADDWF	PCL,1
		;         GFEDCBA-
		RETLW	b'01111111';0	
		RETLW	b'00001101';1
		RETLW	b'10110111';2
		RETLW	b'10011111';3
		RETLW	b'11001101';4
		RETLW	b'11011011';5
		RETLW	b'11111011';6
		RETLW	b'00001111';7
		RETLW	b'11111111';8
		RETLW	b'11001111';9
		RETLW   b'11101111';A
		RETLW	b'11111001';B
		RETLW	b'01110011';C
		RETLW	b'10111101';D
		RETLW	b'11110011';E
		RETLW	b'11100011';F
		END